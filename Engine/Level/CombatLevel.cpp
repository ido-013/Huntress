// Author : sinu

#include "CombatLevel.h"
#include "../GSM/GameStateManager.h"
#include "../ComponentManager/ComponentManager.h"
#include "../GameObject/GameObject.h"
#include "../components.h"
#include "../EventManager/EventManager.h"
#include "../Prefab/Prefab.h"
#include "../ResourceManager/ResourceManager.h"
#include "../Combat/Combat.h"
#include "../Components/EnemyComp.h"
#include "../Serializer/Serializer.h"
#include <iostream>
#include <string>
#include "../UI/CombatUI.h"
#include "../UIM/BtnManager.h"
#include "../UI/StoreUI.h"
#include "../UI/EscMenu.h"
#include "../Components/SubtitleComp.h"
#include "../GameObjectManager/GameObjectManager.h"

#include "../Background/Background.h"
#include "../Utils/Utils.h"
#include "../Tile/Tile.h"

GameObject* player = nullptr;
GameObject* directionArrow = nullptr;
GameObject* enemy = nullptr;

std::string map[10][30] =
{
	//1
	{
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"--P------rS--------Sl------N--",
		"-SSSSSSSS@D--------D@SSSSSSSS-",
		"--D@@@@@@D----------D@@@@@@D--",
		"---D@@@@D------------D@@@@@D--",
		"---D@@@@D-------------D@@@@D--",
		"---D@@@D--------------D@@@D---",
		"----D@@D--------------D@@@D---",
	},
	//2
	{
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-P-----------------------------",
		"-SL----------------------------",
		"-D@@L--------------------------",
		"-D@@@@L------------------------",
		"--D@@@@@SS---------------------",
		"--D@@@@DD----------------------",
		"--D@@@@D-----------------------",
		"---D@@@D--------------------N--",
		"---D@@@D-------------SSSSSSSSS-",
		"---D@@@D--------------D@@@@@DD-",
		"---D@@@D--------------D@@@@D---",
		"---D@@D----------------D@@@D---",
		"---D@@D----------------D@@@D---",
		"---D@@D----------------D@@@D---",
	},
	//3
	{
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"--P-------------------------E--",
		"-SSSSSS-----------------SSSSSS-",
		"-D@@@D-------------------D@@@D-",
		"--D@@D-------------------D@@D--",
		"--D@D---------------------D@D--",
		"--D@D---------------------D@D--",
		"--D@D---------------------D@D--",
	},
	//4
	{
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"-------------------------------",
		"---------------S---------------",
		"---------------DS--------------",
		"--------------S@D--------------",
		"--------------D@D--------------",
		"--P----------S@@D--------------",
		"-SSSL--------D@@@S----------N--",
		"-D@@@@SSSS---D@@@D---SSSSSSSSS-",
		"-D@@@@@@D----D@@@D----D@@@@@@D-",
		"--D@@@@D-----D@@@D----D@@@@D---",
		"--D@@@@D-----D@@@D-----D@@@D---",
		"--D@@@D------D@@@D-----D@@@D---",
		"--D@@@D------D@@@D-----D@@@D---",
	},
	//5
	{
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"---------------------------B--",
		"-------------------SSSSSSSSSS-",
		"--------------------D@@@@@@D--",
		"---------------------D@@@@D---",
		"---------rS----------D@@@@D---",
		"--P-----r@D-----------D@@@D---",
		"-SSSSSSS@@D-----------D@@D----",
		"--D@@@@@@D------------D@@D----",
		"---D@@@@D-------------D@@D----",
		"---D@@@D--------------D@@D----",
		"---D@@D---------------D@@D----",
		"----D@D---------------D@@@D---",
	},
	//6
	{
		"--------------DD---------------",
		"--------------DD---------------",
		"--------------DD---------------",
		"--------------DD---------------",
		"--------------DD---------------",
		"--------------DD---------------",
		"--------------DD---------------",
		"--------------DD---------------",
		"--------------DD---------------",
		"--------------DD---------------",
		"--------------DD---------------",
		"--------------DD---------------",
		"--------------DD---------------",
		"--------------DD---------------",
		"--------------DD---------------",
		"--------------DD---------------",
		"--------------D@D--------------",
		"-------------D@@D--------------",
		"-------------DDDD--------------",
		"-------------------------------",
		"-------------------------------",
		"---------------DD--------------",
		"--------------D@D--------------",
		"--P--R-S-----D@@D----------N---",
		"-SSSS@@D-----D@@@DD-----SSSSS--",
		"-D@@@@D------D@@@@D------D@D---",
		"--D@@@D-------D@@@D------D@D---",
		"--D@@@D-------D@@@D-------DD---",
		"--D@@D--------D@@@D-------DD---",
		"--D@@D--------D@@@D-------DD---",
	},
	//7
	{
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"----------------------------N-",
		"--------------------------R-S-",
		"------------------------R-@@D-",
		"----------------------R-@@@D--",
		"------DDDDD---------R-@@@@DD--",
		"-----D@@@@D-------R-@@@@@D----",
		"-----DDDDD------R-@@@@@@D-----",
		"--------------R-@@@@@@@@D-----",
		"------------R-@DD@@@@@@D------",
		"----------R-@D---D@@@@@D------",
		"--------R-@-------D@@@@D------",
		"------R-@D--------D@@@D-------",
		"----R-@@@D--------D@@@D-------",
		"-PR-@@@@D----------D@@D-------",
		"-S@@@@@@D----------D@@D-------",
		"--D@@@@@D----------D@@D-------",
		"----D@@D-----------D@@D-------",
		"----D@@D-----------D@@D-------",
		"-----D@D-----------D@@D-------",
		"-----D@D-----------D@D--------"
	},

	{
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"---------------SS-------------",
		"----rl---------DD-------------",
		"---r@@l-------S@D-------------",
		"--rDDDDl------DDD-------------",
		"------------------------------",
		"-------rS-----SL--------------",
		"------r@D-----D@@L------------",
		"--P--r@@D-----D@@@@L-------E--",
		"-SSSS@@@D------D@@@D@SSSSSSSS-",
		"-D@D@@@D-------D@@D-----D@@D--",
		"--D-D@@D--------DD------D@D---",
		"----D@@D--------D@D------DD---",
		"-----D@D--------D@D------DD---",
		"-----DD--------D@@@D----D@D---",
	},

	{
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"--P---------------------------",
		"-SSSSL------------------------",
		"-D@@@@@L-------D--------------",
		"-D@@@@@D@L-----DDD------------",
		"-D@@@@D--D@L------------------",
		"-D@@@D----D@@L----------------",
		"-D@@@D----D@@D@L------DD------",
		"-D@@@D----D@@D--@L------------",
		"--D@@D----D@@D----@L----------",
		"--D@@D----D@@D----DD@L--------",
		"--D@@D----D@@D------D@@L---N--",
		"--D@@D----D@@D------D@@@@SSSS-",
		"--D@D-----D@@D-------D@@@@DD--",
		"--D@D-----D@@D-------D@@@D----",
		"--D@D------D@D--------D@@D----",
		"--D@D------D@D--------D@D-----",
		"--D@D------D@D--------D@D-----",
	},

	{
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------------------------------",
		"------rSl------------rSl------",
		"-----r@@@S----------S@@@l-----",
		"----r@@@@D----------D@@@@l----",
		"---r@@@@D-----------D@@@@@l---",
		"-Pr@@@@@D------------D@@@@@lB-",
		"-S@@@@@@D-------------D@@@@@S-",
		"-D@@@@@D--------------D@@@@@D-",
		"-D@@@@@D---------------D@@@D--",
		"--D@@@D----------------D@@@D--",
		"--D@@D-----------------D@@D---",
		"--D@@D-----------------D@@D---",
	}
};

int tileNum[10] = { 0, 2, 0, 2, 1, 1, 0, 2, 1, 2 };
int bgNum[10] = { 1, 2, 3, 4, 5, 6, 7, 1, 2, 8 };

void level::CombatLevel::Init()
{
	// background
	InitBackground();

	int i = level;

	Tile::ChangeTile(tileNum[i]);

	GameObject* go = nullptr;
	TransformComp* t = nullptr;
	ColliderComp* c = nullptr;

	Prefab gs("GhostSquare");
	Prefab s("Square");
	Prefab l("LeftTri");
	Prefab r("RightTri");
	Prefab p("Player");
	Prefab e("Enemy");
	Prefab d("DirectionArrow");

	AEVec2 pPos;
	AEVec2 ePos;
	char initial;

	for (int j = 0; j < 30; j++)
	{
		for (int k = 0; k < 30; k++)
		{
			if (map[i][j][k] == '-')
				continue;

			else if (map[i][j][k] == 'S')
			{
				go = s.NewGameObject();
			}

			else if (map[i][j][k] == 'D')
			{
				go = s.NewGameObject();
				go->GetComponent<SpriteComp>()->SetTexture("./Assets/Tile/FallGrassTileRect3.png");
			}

			else if (map[i][j][k] == '@')
			{
				go = gs.NewGameObject();
				go->GetComponent<SpriteComp>()->SetTexture("./Assets/Tile/FallGrassTileRect3.png");
			}

			else if (map[i][j][k] == 'r')
			{
				go = r.NewGameObject();
			}

			else if (map[i][j][k] == 'l')
			{
				go = l.NewGameObject();
			}

			else if (map[i][j][k] == 'P')
			{
				pPos = { MapToPosX((float)k), MapToPosY((float)j) };
				continue;
			}

			else if (map[i][j][k] == 'N')
			{
				ePos = { MapToPosX((float)k), MapToPosY((float)j) };
				initial = 'N';
				continue;
			}

			else if (map[i][j][k] == 'E')
			{
				ePos = { MapToPosX((float)k), MapToPosY((float)j) };
				initial = 'E';
				continue;
			}

			else if (map[i][j][k] == 'B')
			{
				ePos = { MapToPosX((float)k), MapToPosY((float)j) };
				initial = 'B';
				continue;
			}

			else if (map[i][j][k] == 'R')
			{
				go = r.NewGameObject();

				t = go->GetComponent<TransformComp>();

				t->SetScale({ width * 2, height });

				float x = MapToPosX((float)k);
				float y = MapToPosY((float)j);
				t->SetPos({ x + width / 2, y });

				c = go->GetComponent<ColliderComp>();
				c->SetCollider();

				continue;
			}

			else if (map[i][j][k] == 'L')
			{
				go = l.NewGameObject();

				t = go->GetComponent<TransformComp>();

				t->SetScale({ width * 2, height });

				float x = MapToPosX((float)k);
				float y = MapToPosY((float)j);
				t->SetPos({ x + width / 2, y });

				c = go->GetComponent<ColliderComp>();
				c->SetCollider();

				continue;
			}

			t = go->GetComponent<TransformComp>();

			t->SetScale({ width, height });

			float x = MapToPosX((float)k);
			float y = MapToPosY((float)j);

			t->SetPos({ x, y });

			c = go->GetComponent<ColliderComp>();
			if (c != nullptr)
				c->SetCollider();
		}
	}
	
	// player
	player = p.NewGameObject("player");

	t = player->GetComponent<TransformComp>(); 
	t->SetScale({ 50, 50 });
	t->SetPos({ pPos.x, pPos.y });

	c = player->GetComponent<ColliderComp>();
	if (c != nullptr)
		c->SetCollider();

	// enemy
	enemy = e.NewGameObject("enemy");

	if (initial == 'N')
	{
		enemy->GetComponent<EnemyComp>()->enemyData->InitData(30, 30, 0, 0, Data::EnemyData::GRADE::Normal);
	}

	else if (initial == 'E')
	{
		enemy->GetComponent<EnemyComp>()->enemyData->InitData(45.f + 15.f, 45.f + 15.f, 4.f, 3.f, Data::EnemyData::GRADE::Elite);
	}

	else
	{
		enemy->GetComponent<EnemyComp>()->enemyData->InitData((float)60 + (float)60, (float)60 + 60, (float)9, (float)5, Data::EnemyData::GRADE::Boss);
	}
	
	t = enemy->GetComponent<TransformComp>();
	t->SetScale({ 50, 50 });
	t->SetPos({ ePos.x, ePos.y });

	c = enemy->GetComponent<ColliderComp>();
	if (c != nullptr)
		c->SetCollider();

	// direction Arrow
	directionArrow = d.NewGameObject("directionArrow");

	Serializer::GetInstance().SaveLevel("./Assets/Level/test" + std::to_string(i + 1) + ".lvl", "./Assets/Background/BG" + std::to_string(bgNum[i]) + ".png");

	//Init UI
	//InitCombatUI();
	CombatComp::isHit = false;
	CombatComp::isItemUsed = false;
	CombatComp::SetItemState(false);
	GameObjectManager::GetInstance().GetObj("directionArrow")->GetComponent<CombatComp>()->InitOrbit();
}

void level::CombatLevel::Update()
{
//	UpdateCombatUI();
	UpdateBackground();

#ifdef _DEBUG
	if (AEInputCheckTriggered(AEVK_5))
	{
		Data::PrintPlayerData(*player->GetComponent<PlayerComp>()->playerData);
	}
	if (AEInputCheckTriggered(AEVK_6))
	{
		Data::PrintEnemyData(*enemy->GetComponent<EnemyComp>()->enemyData);
	}
	if (AEInputCheckTriggered(AEVK_7))
	{
		Data::PrintCombatData(directionArrow->GetComponent<CombatComp>()->data);
	}
	if (AEInputCheckTriggered(AEVK_8))
	{
		SubtitleComp::IntersectDissolveText({ {{0,0}, 1, "Test", 1, 1, 1, 1}, 5, 2, 2 });
	}
	if (AEInputCheckTriggered(AEVK_N))
	{
		GSM::GameStateManager::GetInstance().ChangeLevel(new CombatLevel(level + 1));
	}
#endif
}

void level::CombatLevel::Exit()
{
	//ExitCombatUI();
}
